# QEMU Automated Virtual Device State Analyzer for Leaking State
The [MORPHUZZ](https://www.usenix.org/system/files/sec22-bulekov.pdf) (2022) paper found that QEMU was improperly saving / loading virtual device state with its snapshotting mechanism, which was leading to state leakage between snapshot loads. The goal of this project is to automate a method for saving, fuzzing, and analyzing virtual device state information to detect if state information is being improperly saved / loaded by different QEMU virtual devices.

More in-depth information on the motivation, steps taken, results, and documentation of this project can be found on [this](https://docs.google.com/presentation/d/1ONY96otzQZbfdQANVCA5XiQ0zecyeaLlhc2oCVPhYOk/edit?usp=sharing) slide deck.

## Project Summary
The code within this repo contains the scripts, function files, and altered QEMU source code for the E1000 (network device), AM53C974 (storage device), and CCID-Card-Passthru (smart card) devices that enables the virtual device state fuzzing and analysis setup. The virtual device code utilizes QEMU's [VMState](https://www.qemu.org/docs/master/devel/migration/main.html#vmstate) macros to save the raw state data for each field defined in the respective virtual device state data structure right before a snapshot is saved (in pre_save) and right after a snapshot is loaded (in post_load). These files include [metadata](https://docs.google.com/presentation/d/1ONY96otzQZbfdQANVCA5XiQ0zecyeaLlhc2oCVPhYOk/edit#slide=id.g2cece7f2d41_0_104) that enable individual state fields to be compared to detect any differences between what each state field was when it was saved vs. when it was loaded by the snapshot (to detect any possible state leaks). The altered virtual device code also define a pre_load function to randomize virtual device state before loading the snapshot (to fuzz the state before the load and help detect possible sources of state leakage).

This code also includes a [fuzzing script](https://github.com/TrevorChan1/QEMU-statecompare/blob/main/fuzz_scripts/trev_monitor.c) that automates saving, fuzzing, loading, and analyzing the saved vs. loaded states by connecting to QEMU Monitor (via socket), running savevm, then looping to loadvm and compare the saved vs. loaded state files generated by pre_save and post_load.

The project also includes a script dedicated to automatically generating the changes implemented for the 3 specified virtual devices here. This script isn't fully finished. It is currently able to scrape QEMU virtual device source code for all virtual device field information, with the next steps being to use the Jinja2 library to generate (or append to if they already exist) the pre_save, post_load, and pre_load functions made in qemu_source.

## How to Run Code
The following is instructions on how to replicate the setup used throughout the project.

### Create a QEMU Ubuntu x86_64 Virtual Machine

### Install QEMU and Modify Build Process to Include Function Files

### Run VM and Fuzz Script
